<div class="max-w-md mx-auto px-6 lg:px-8 py-12">
  <div class="card p-8">
    <div class="text-center mb-4">
      <%# dynamic heading and role badge %>
      <% role_value = user.role.presence || 'customer' %>
      <h2 class="text-3xl font-semibold" style="color: var(--text);"><%= user.persisted? ? 'Editing user' : 'Create your account' %></h2>
      <% unless user.persisted? %>
        <p class="mt-2 text-sm text-subtle">Join us today</p>
      <% end %>
      <div class="mt-2">
        <span class="badge badge-tonal">
          <%= role_value == 'admin' ? 'Business (admin)' : 'Customer' %>
        </span>
      </div>
    </div>

    <%= form_with(model: user, class: "space-y-6") do |form| %>
      <% if user.errors.any? %>
        <div class="alert alert-error">
          <i data-lucide="x-circle" class="w-4 h-4"></i>
          <div>
            <strong><%= pluralize(user.errors.count, "error") %></strong> prohibited this user from being saved
            <ul class="mt-2 list-disc list-inside">
              <% user.errors.each do |error| %>
                <li><%= error.full_message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      <% end %>

      <%# Account Type Toggle: only show when creating a new user %>
      <% unless user.persisted? %>
        <!-- Account Type Toggle (model-bound) -->
        <div class="flex items-center justify-center space-x-2 p-1 bg-[var(--surface-alt)] rounded-lg border border-[rgba(54,47,45,0.12)]">
          <label class="flex-1 cursor-pointer">
            <%= form.radio_button :role, 'customer', checked: (role_value == 'customer'), class: 'hidden peer', onchange: "toggleAccountType('customer')" %>
            <div class="text-center py-2 px-4 rounded-md peer-checked:bg-white peer-checked:shadow-md peer-checked:text-[var(--brand-700)] transition-all font-medium text-subtle">
              Customer
            </div>
          </label>
          <label class="flex-1 cursor-pointer">
            <%= form.radio_button :role, 'admin', checked: (role_value == 'admin'), class: 'hidden peer', onchange: "toggleAccountType('admin')" %>
            <div class="text-center py-2 px-4 rounded-md peer-checked:bg-white peer-checked:shadow-md peer-checked:text-[var(--brand-700)] transition-all font-medium text-subtle">
              Business Owner
            </div>
          </label>
        </div>
      <% end %>

      <div>
        <%= form.label :name, class: "block text-sm font-medium text-muted mb-1" %>
        <%= form.text_field :name, required: true, class: "w-full px-4 py-2 border rounded-md", placeholder: "Your full name" %>
      </div>

      <div>
        <%= form.label :username, class: "block text-sm font-medium text-muted mb-1" %>
        <%= form.text_field :username, required: true, class: "w-full px-4 py-2 border rounded-md", placeholder: "Choose a username" %>
      </div>

      <div>
        <%= form.label :email, class: "block text-sm font-medium text-muted mb-1" %>
        <%= form.email_field :email, required: true, class: "w-full px-4 py-2 border rounded-md", placeholder: "your@email.com" %>
      </div>

      <div>
        <%= form.label :password, class: "block text-sm font-medium text-muted mb-1" %>
        <%= form.password_field :password, required: true, class: "w-full px-4 py-2 border rounded-md", placeholder: "••••••••" %>
      </div>

      <div>
        <%= form.label :password_confirmation, "Confirm Password", class: "block text-sm font-medium text-muted mb-1" %>
        <%= form.password_field :password_confirmation, required: true, class: "w-full px-4 py-2 border rounded-md", placeholder: "••••••••" %>
      </div>

      <div>
        <%= form.label :avatar, "Profile Photo (Upload)", class: "block text-sm font-medium text-muted mb-1" %>
        <%= form.file_field :avatar, direct_upload: true, class: "w-full px-4 py-2 border rounded-md bg-white" %>
        <p class="mt-1 text-xs text-subtle">JPEG/PNG, up to ~10MB.</p>
      </div>

      <div id="business_fields" style="display: <%= role_value == 'admin' ? 'block' : 'none' %>;">
        <%= form.label :bio, "Business Description", class: "block text-sm font-medium text-muted mb-1" %>
        <%= form.text_area :bio, rows: 3, class: "w-full px-4 py-2 border rounded-md", placeholder: "Tell us about your business..." %>
      </div>

      <%= form.hidden_field :date_created, value: Time.current %>

      <div>
        <%= form.submit (user.persisted? ? "Save" : "Create Account"), class: "w-full btn-primary justify-center" %>
      </div>

      <% unless user.persisted? %>
        <div class="text-center text-sm text-subtle">
          Already have an account?
          <%= link_to "Sign in", login_path, class: "hover:text-[var(--brand-700)] font-medium" %>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
  function toggleAccountType(type) {
    // model-bound radio buttons are used, so just toggle visibility and update the badge text
    const businessFields = document.getElementById('business_fields');
    const badge = document.querySelector('.badge');

    if (type === 'admin') {
      businessFields.style.display = 'block';
      if (badge) badge.textContent = 'Business (admin)';
    } else {
      businessFields.style.display = 'none';
      if (badge) badge.textContent = 'Customer';
    }
  }
</script>
